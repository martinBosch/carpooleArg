{% extends 'backoffice/index.html' %}

{% block body %}
<div class="container p-3 my-3 bg-light">
    <div class="form-group">
        <div class="input-group">
          <div class="input-group-prepend mr-2">
            <i class="bi bi-hourglass-split" style="font-size: 2rem; color: cornflowerblue;"></i>
          </div>
          <div class="col-sm-3">
            <input type="text" value="25" class="form-control mt-2" id="iter_input" placeholder="numero de iteraciones">
          </div>
        </div>
    </div>

    <div class="form-group">
        <div class="input-group">
          <div class="input-group-prepend mr-2">
            <i class="bi bi-eraser-fill" style="font-size: 2rem; color: cornflowerblue;"></i>
          </div>
          <div class="col-sm-3">
            <input type="text" value="0.1" class="form-control mt-2" id="evaporation_rate" placeholder="velocidad de evaporaciÃ³n de feromonas">
          </div>
        </div>
    </div>

    <div class="custom-control custom-switch">
        <input type="checkbox" class="custom-control-input" id="debug">
        <label class="custom-control-label" for="debug">Debug</label>
    </div>
</div>

<div class="container p-3 my-3 bg-light">

    <div class="d-flex justify-content-between">
        <p id="iter">Iteracion: 0</p>
    </div>

    <div id="container" class="mb-2"></div>

    <button id="search" class="btn btn-outline-primary">Buscar</button>

    <button id="search-in-progess" class="btn btn-outline-primary" type="button" style="display: none;" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span class="sr-only">Loading...</span>
    </button>

</div>
{% endblock %}


{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

<script>
    var networkgraph_data = {{ data|tojson }};
    var trips = {{ trips|tojson }};
</script>

<script>
    const socket = io()

    socket.on('avanzar_hormiga', function(link) {
        var networkgraph_link = chart.series[0]['data'].filter(function(d) {
            return d['from'] == link['from'] && d['to'] == link['to'];
        })[0];
        networkgraph_link.update({'color': 'yellow'});
    });

    socket.on('actualizar_feromona', function(link) {
        var networkgraph_link = chart.series[0]['data'].filter(function(d) {
            return d['from'] == link['from'] && d['to'] == link['to'];
        })[0];
        networkgraph_link.update({'feromone': link['feromone']});
    });

    socket.on('hormiga_finish', function(iter_num) {
        //reset colors
        chart.series[0].data.forEach(function(link) {
            if (link.color == 'yellow') {
                link.update({'color': 'red'});                
            }
        });

        $('#iter').text("Iteracion: " + iter_num)
    });

    socket.on('inc_iter', function(iter_num) {
        $('#iter').text("Iteracion: " + iter_num)
    });

    socket.on('search_trip_finish', function(data) {
        var best_trip = data["best_trip"];

        let length = best_trip.length;
        // update best trip in graph
        for (let i = 0; i < length-1; i++) {
            var networkgraph_link = chart.series[0]['data'].filter(function(d) {
                return d['from'] == best_trip[i] && d['to'] == best_trip[i+1];
            })[0];
            networkgraph_link.update({'color': 'yellow'});
        }

        $("#search-in-progess").hide();
        $("#search").show();
    });
</script>

<script>
    $("#search").click(function() {
        $("#search").hide();
        $("#search-in-progess").show();
        //reset feromone
        trips.forEach(function(trip) {
            var networkgraph_link = chart.series[0]['data'].filter(function(d) {
                return d['from'] == trip['from'] && d['to'] == trip['to'];
            })[0];
            networkgraph_link.update({'feromone': '1', 'color': 'red'});
        });


        var iter_input = $("#iter_input").val();
        var debug = $("#debug").is(":checked");
        var evaporation_rate = $("#evaporation_rate").val();

        socket.emit("search_trip", 
            {
                "iter_input": iter_input,
                "debug": debug,
                "evaporation_rate": evaporation_rate
            }
        );
    });
</script>

<script>
    var chart = Highcharts.chart('container', {
    chart: {
        type: 'networkgraph'
    },
    title: {
        text: ''
    },
    series: [{
        dataLabels: {
            enabled: true,
            linkFormat: '{point.feromone}'
        },
        link: {
            width: 2
        },
        marker: {
            radius: 15
        },
        layoutAlgorithm: {
            maxIterations: 1,
            initialPositions: function() {
                this.nodes.forEach((node, i) => {
                    if (node.id == 'A') {
                        node.plotX = 100;
                        node.plotY = 100;
                    }
                    if (node.id == 'B') {
                        node.plotX = 200;
                        node.plotY = 100;
                    }
                    if (node.id == 'C') {
                        node.plotX = 300;
                        node.plotY = 100;
                    }
                    if (node.id == 'D') {
                        node.plotX = 400;
                        node.plotY = 100;
                    }
                    if (node.id == 'E') {
                        node.plotX = 100;
                        node.plotY = 200;
                    }
                    if (node.id == 'F') {
                        node.plotX = 200;
                        node.plotY = 200;
                    }
                    if (node.id == 'G') {
                        node.plotX = 300;
                        node.plotY = 200;
                    }
                    if (node.id == 'H') {
                        node.plotX = 400;
                        node.plotY = 200;
                    }
                    if (node.id == 'I') {
                        node.plotX = 100;
                        node.plotY = 300;
                    }
                    if (node.id == 'J') {
                        node.plotX = 200;
                        node.plotY = 300;
                    }
                    if (node.id == 'K') {
                        node.plotX = 300;
                        node.plotY = 300;
                    }
                    if (node.id == 'L') {
                        node.plotX = 400;
                        node.plotY = 300;
                    }
                    if (node.id == 'M') {
                        node.plotX = 100;
                        node.plotY = 400;
                    }
                    if (node.id == 'N') {
                        node.plotX = 200;
                        node.plotY = 400;
                    }
                    if (node.id == 'O') {
                        node.plotX = 300;
                        node.plotY = 400;
                    }
                    if (node.id == 'P') {
                        node.plotX = 400;
                        node.plotY = 400;
                    }
                });
            }
        },
        data: networkgraph_data
    }]
});

// draw trips
trips.forEach(function(trip) {
    var networkgraph_link = chart.series[0]['data'].filter(function(d) {
        return d['from'] == trip['from'] && d['to'] == trip['to'];
    })[0];
    networkgraph_link.update({'color': 'red'});
});
</script>
{% endblock %}
